# Presentation du framework FLASK - **Utiliser FLASK en BUT RT**

## 

Site officiel https://flask.palletsprojects.com/en/2.2.x/ 


Flask est un micro-framework web python (Python v3.7 et versions ultÃ©rieures)
- dÃ©veloppement rapide et sÃ©curisÃ© de petits sites web
- utilisable pour des applications plus ambitieuses Ã  l'aide d'extensions pour structurer et dÃ©velopper des fonctionnalitÃ©s particuliÃ¨res.

Une application Flask est une application 100% WSGI (*Web Server Gateway Interface*). Elle possÃ¨de une organisation simple oÃ¹ elle reÃ§oit directement les requÃªtes du serveur WSGI et les traite. Selon lâ€™URL transmise, elle dÃ©clenche le *Callable* de rÃ©ponse concernÃ©.  

La rÃ©ponse peut Ãªtre une simple chaÃ®ne de caractÃ¨res ou correspondre Ã  des fichiers HTML particuliers, les *templates HTML*.

Les *templates HTML* sont des gabarits qui dÃ©finissent les structures HTML des pages. Un *template HTML* peut Ãªtre construit Ã  partir d'un autre par hÃ©ritage. Il peut aussi intÃ©grer d'autres *templates*. Il peut dÃ©clarer des variables pour insÃ©rer des donnÃ©es dynamiquement transmises par le *Callable*. Il peut exÃ©cuter des structures de contrÃ´le comme des expressions conditionnelles, des boucles, ... . Il peut dÃ©clarer des blocs qui seront Ã©diter par les autres *templates* qui l'intÃ¨greront. 

Le moteur de template **Jinja2** assure la gestion et le fonctionnement des *templates HTML*.

---

## CrÃ©er un projet Flask - PrÃ©parer l'environnement

DÃ©finir le dossier d'accueil du projet puis y accÃ©der.  A l'intÃ©rieur, crÃ©er un environnement virtuel Python puis l'activer. Une fois fait, on commence par mettre Ã  jour la base de paquets du gestionnaire `pip`.

```bash
# CrÃ©ation du dossier d'accueil du projet
mkdir prj_flask
cd prj_flask

# CrÃ©ation de l'environnement virtuel python
python3 -m venv prj_env
source prj_env/bin/activate

# Mise Ã  jour de la base du dÃ©pÃ´t
python -m pip install -U pip
```

Le principal paquet Ã  installer est le paquet `flask`. Il faut l'installer dans l'environnement virtuel Ã  l'aide du gestionnaire de paquets python `pip`._

```bash
# installer le paquet flask dans l'environnement
pip install flask
```

> **_Remarque_** :<br/>_Le paquet *flask* est installÃ© dans le dossier `acd_env/lib/python3.10/site-packages/` de l'environnement virtuel. Des dÃ©pendances ont automatiquement Ã©tÃ© installÃ©es - **click**, **itsdangerous**, **jinja2**, **markupsafe**, **werkzeug**._

---
### Dependances installÃ©es

Le rÃ´le respectif de chaque dÃ©pendance est dÃ©crit dans la documentation au lien [Installation](https://flask.palletsprojects.com/en/2.2.x/installation/#install-flask)

- **Werkzeug** : implÃ©menter du serveur WSGI et gÃ©rer le routage d'URL
- **Jinja2** : moteur de template HTML
- **MarkupSafe** : sÃ©curiser les donnÃ©es transmises pour se protÃ©ger de certaines attaques
- **ItsDangerous** : signer les donnÃ©es pour assurer leur intÃ©gritÃ© et protÃ©ger le cookie de session

---
## CrÃ©er une premiÃ¨re application Flask

Flask permet de crÃ©er une application web WSGI dans un seul module python qui intÃ©grera toutes les fonctionnalitÃ©s. Il suffit d'importer et d'instancier la classe `Flask` en la liant au module courant (argument `__name__`) pour crÃ©er l'application (objet `app`). Le lien avec le module facilite l'accÃ¨s aux ressources utilisÃ©es, template HTML, fichiers statiques, ..., et simplifie l'usage de l'espace de nom.

On dÃ©finit ensuite les fonctions qui retournent les rÃ©ponses HTML. On les dÃ©core avec le dÃ©corateur python liÃ© Ã  l'instance de l'application `@app.route()`. Le premier argument du dÃ©corateur est l'URL (*Uniform Resource Locator*) associÃ©e pour activer la fonction.

> **_Remarque_** :<br/>_Une fonction peut disposer de plusieurs routes. Il est possible de passer des paramÃ¨tres supplÃ©mentaires Ã  la route en les plassant entre chevrons `<...>` dans l'URL et en utilisant le caractÃ¨re **Â« / Â»** comme sÃ©parateur. Ils doivent correspondre aux arguments de la fonction dÃ©corÃ©e. Ces arguments peuvent Ãªtre typÃ©s pour assurer la cohÃ©rence des donnÃ©es, en l'absence, le type par dÃ©faut est `str`._

Dans le dossier du projet `prj_acd`, crÃ©ez un dossier une nommÃ©e `appli1` pour implÃ©menter  Ã  l'intÃ©rieur une premiÃ¨re application de mÃªme nom. CrÃ©ez le module `appli1.py` contenant le code suivant. 

```python
from flask import Flask

app = Flask(__name__)

@app.route("/")
@app.route("/accueil")
def index():
    return "<h1>Bienvenue dans la formation Flask</h1>"

@app.route("/emploi/<user>/<job>")
def emploi(user, job):
    return f"<h2>{user} occupe un poste de {job}</h2>"

@app.route("/profil/<string:user>/<int:years>")
def  profil(user, years):
    return f"<h2>{user} a une anciennetÃ© de {years} annÃ©e(s)</h2>"
```

l'instance de l'application se nomme `app`. On peut la lancer en utilisant, dans une console avec l'environnement virtuel python activÃ©, Ã  partir du script `flask` livrÃ© dans le paquet de mÃªme nom.

> **_Remarque_** : <br/>_il n'est pas utile de prÃ©ciser le nom de l'instance s'il elle s'appelle `app` ou `application` ou si vous avez dÃ©fini une fonction `create_app()` ou `make_app()` (notion de *factory*, fonction dans laquelle l'instance de l'application est crÃ©Ã©e - permet des instanciations multiples de l'application)._ 

```bash
flask --app appli1 run
```

![Flask start](/img/20221012_07flask_start.jpg)

Le serveur web WSGI est lancÃ© sur la boucle locale et Ã©coute par dÃ©faut sur le port 5000. Le message de dÃ©marrage du serveur s'affiche dans la console avec l'URL d'accÃ¨s Ã  utiliser. On constate Ã©galement que le mode dÃ©bogage n'est pas activÃ©.


> **_Exercice_** : <br/>_Tester localement avec un navigateur les diffÃ©rents URL possible sur la boucle locale, avec ou sans erreur._


Pour que le serveur soit accessible depuis le rÃ©seau, il faut utiliser l'option `--host=0.0.0.0* de la commande `run` lancÃ©e avec le script `flask`. dans ce cas, il faut ouvrir le port d'Ã©coute dans le firewall 

```bash
# configuration du firewall
sudo ufw allow 5000/tcp
sudo ufw reload

# script de lancement
flask --app appli1 run --host=0.0.0.0
```

> **_Exercice_** : <br/>_Tester dans votre poste de travail Windows avec un navigateur les diffÃ©rents URL possible sur la boucle locale, avec ou sans erreur._


---
## Utiliser le mode debug

Lorsque l'application est lancÃ©e, toute modification nÃ©cessitera un redÃ©marrage pour Ãªtre prise en compte. D'autre part, si une erreur de traitement est dÃ©tectÃ©e, on rÃ©cupÃ¨re une page d'erreur serveur.

Il est possible de lancer l'application en mode *debug* pendant la phase de dÃ©veloppement. 

```bash
flask --app appli1 --debug run
```

![Flask start debug](/img/20221012_08flask_start-debug.jpg)

Le message prÃ©cise Ã  prÃ©sent que le dÃ©bogage est actif et affiche le code PIN de dÃ©bogage Ã  utiliser pour authentification lors de l'accÃ¨s au console python de dÃ©bogage. Dans ce mode, il n'est pas utile de redÃ©marrer le serveur Ã  chaque modification de l'application, le rechargement est automatique. D'autre part, en cas d'erreur, une page de description de l'erreur est affichÃ©e dans le navigateur. 

---

## Structurer une application web Flask

L'organisation la plus simple est basÃ©e sur un module unique instanciant l'application avec Ã©ventuellement l'utilisation de dossiers particulier pour hÃ©berger les modÃ¨les HTML ou les fichier statiques.

```bash
./appli1/
â”œâ”€â”€ appli1.py
â”œâ”€â”€ static
â”‚   â”œâ”€â”€ css
â”‚   â”‚   â””â”€â”€ sytles.css
â”‚   â””â”€â”€ img
â”‚       â””â”€â”€ logo.png
â””â”€â”€ templates
    â”œâ”€â”€ index.html
```

### Organiser  le code

La multiplication des fonctionnalitÃ©s impose de structurer le code pour une plus grande lisibilitÃ© et faciliter la maintenance. La documentation propose des [modÃ¨les d'organisations](https://flask.palletsprojects.com/en/2.2.x/patterns/) plus Ã©laborÃ©s en sÃ©parant le code dans des modules thÃ©matiques pour s'appuyer sur les paquets python plutÃ´t que les modules.

> **_Remarque_** :<br/>_Le dossier contenant l'application doit Ãªtre dÃ©fini comme un paquet python en ayant Ã  sa racine le module d'initialisation `__init__.py`._ 

On crÃ©e dans le paquet des modules spÃ©cifiques pour dÃ©finir :
- `routes.py` ğŸ – les vues et leurs routes (aussi nommÃ© `views.py`)
- `models.py` ğŸ – les classes et les tables pour mapper les Ã©lÃ©ments des bases de donnÃ©es
- `forms` ğŸ – Les classes de formulaires avec leurs champs

On crÃ©e le dossier `templates` pour y stocker les fichiers HTML reprÃ©sentant les gabarits HTML.

On crÃ©e le dossier `static` pour y placer les fichiers statiques, eux mÃªmes organisÃ©s dans des sous dossiers thÃ©matiques pour les pages de styles, les images, ... .

```bash
./appli2/
â”œâ”€â”€ forms.py
â”œâ”€â”€ __init__.py
â”œâ”€â”€ models.py
â”œâ”€â”€ routes.py
â”œâ”€â”€ static
â”‚   â”œâ”€â”€ css
â”‚   â”‚   â””â”€â”€ styles.css
â”‚   â””â”€â”€ img
â”‚       â””â”€â”€ logo.png
â””â”€â”€ templates
    â”œâ”€â”€ index.html
    â”œâ”€â”€ layout.html
    â”œâ”€â”€ login.html
    â””â”€â”€ register.html
```

### ImplÃ©mentation du module `__init__.py`

C'est dans ce module que l'on instancie la classe Flask pour crÃ©er l'application et les objects liÃ©s Ã  d'autres fonctionnalitÃ©s (accÃ¨s aux bases de donnÃ©es, systÃ¨me d'authentification). On y dÃ©clare Ã©galement Ã©galement les propriÃ©tÃ©s de configuration des diffÃ©rentes technologies mises en oeuvre. La derniÃ¨re instruction charge le module `routes.py` pour assurer le routage d'URL Ã  la rÃ©ception dâ€™une requÃªte.

```python
from flask import Flask

app = Flask(__name__)

from appli2 import routes 
```

### ImplÃ©mentation du module `routes.py`

Câ€™est le fichier qui contient les vues dÃ©corÃ©es par leur(s) route(s). Il contrÃ´le le fonctionnement de lâ€™application. C'est l'application *Flask* qui reÃ§oit les requÃªtes HTTP transfÃ©rÃ©es par le serveur WSGI. Pour sÃ©lectionner la vue qui doit renvoyer la rÃ©ponse HTTP Ã  partir de l'URL de la requÃªte, le module doit donc importer lâ€™instance de lâ€™application depuis son paquet pour utiliser ses dÃ©corateurs traitant les URLs reÃ§ues. 

Lâ€™instruction `return` de la fonction de vue de la route invoque la fonction `render_template()`, qui prend en premier argument le nom complet du *template HTML*, pour retourner la rÃ©ponse HTML.

```python
from flask import render_template
from appli2 import app

@app.route("/")
@app.route("/accueil")
def index():
    return render_template("index.html")```
```

> **_Import circulaire_** :<br/>_Nous venons de faire un import circulaire ce qui est contraire au prÃ©conisation d'usage (appel du module `routes.py` Ã  l'initialisation du paquet alors que l'on importe l'application `app` crÃ©er Ã  l'initialisation dans ce mÃªme module). Le site officiel alerte sur ce point mais explique que c'est sans consÃ©quence sur le fonctionnement._
![Circular import](/img/20221012_09falert-circular-import.jpg)<br/> https://flask.palletsprojects.com/en/2.2.x/patterns/packages/


### ImplÃ©mentation du template HTML `appli2/templates/index.html`

Les templates HTML sont des fichiers contenant des donnÃ©es statiques HTML. Ils peuvent  Ã©galement contenir des  espaces rÃ©servÃ©s pour les donnÃ©es dynamiques.

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Application test M2105</title>
</head>
<body>
    <h1>Bienvenue dans la formation Flask</h1>
</body>
</html>
```

L'instruction de lancement est la mÃªme que prÃ©cÃ©dement.

## Alternative avec Flask Blueprints

Pour les applications les plus complexes, il est prÃ©fÃ©rable de modulariser en segmentant par fonctionnalitÃ© dans des 
sous-dossiers spÃ©cifiques avec leurs propres modules, templates et fichiers statiques. 

*Flask Blueprints* permet de mettre en oeuvre ce type d'organisation en agglomÃ©rant des Ã©lÃ©ments fonctionnels modulaires. Chacun d'eux est reprÃ©sentÃ© par un *Blueprint* spÃ©cifique dont la logique doit Ãªtre enregistrÃ© dans un sous-dossier propre. Le module d'initialisation doit dÃ©clarer les *Blueprints*.

> Un *Blueprint* de *Flask* peut Ãªtre assimilÃ©, dans  une certaine mesure, Ã  une *Application Django* pour construire un Ã©lÃ©ment modulaire attachÃ© Ã  une fonctionnalitÃ© spÃ©cifique du site web. 
